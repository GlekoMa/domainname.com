---
title: 《R for Everyone》小注 Part.1
author: ''
date: '2022-01-30'
slug: r-for-everyone
categories: []
tags: []
description: R语言：实用数据分析和可视化技术（原书第2版）
---

<script src="{{< blogdown/postref >}}index.en_files/header-attrs/header-attrs.js"></script>


<p><em>2022.1.30-2.5</em></p>
<p><a href="https://book.douban.com/subject/34891734/"><img src="images/book_repo.jpg" style="max-width:22.5%;min-width:60px;float:right;" alt="R_for_Everyone" /></a></p>
<blockquote>
<p>Part.1范围为第1-16章，17-26章与理论结合很紧密，留待Part.2探讨，27-30章则放在Part.3。</p>
</blockquote>
<blockquote>
<p>此书结构好，内容相对较新。</p>
</blockquote>
<blockquote>
<p>英文版2017年出版，中文版2019年12月出版，而市面上流行的中文R书目，很多都是写作于13、14年，而当时的环境与17年（这一年Hadley Wickam的《R for Data Science》出版，意味着Tidyverse已相对成熟）相比有比较大的差别。</p>
</blockquote>
<blockquote>
<p>推荐：Garrett Grolemund.<a href="https://rstudio-education.github.io/hopr/">Hands-On Programming with R</a> 其<a href="https://book.douban.com/subject/26808217/">中文版</a>是我的启蒙书籍，讲解由三个项目驱动，在没有任何基础的情况下，三天就可看完。（这本书几乎没有使用任何R包，在我看来，其缺点也许只有内容相对较少。而Hadley Wickam的《R for Data Science》是其姊妹篇。）</p>
</blockquote>
<p>笔记是一种很私人的东西，网络上许多博客的学习笔记通常过于冗长，且内容常仅是对原书的一些提炼，这类总结性的笔记适用于自己复习，而就效率来说，未必适合他者。所以这篇文章里只包含许多注释性质的东西，故只称作“小注”。</p>
<p>“小注”分为<em>一般注释</em>和特针对此书的<em>特殊注释</em>。</p>
<div id="一般注释" class="section level2">
<h2>一般注释</h2>
<div id="p17-2.2-rstudio" class="section level3">
<h3>P17 “2.2 RStudio”</h3>
<p>在启动或退出时，建议不要恢复或保存.RData文件。<br />
这点其他R书籍可能没有顾及到，但设置成“Never”确实能方便许多。</p>
</div>
<div id="p61-6.2-读取excel数据" class="section level3">
<h3>P61 “6.2 读取Excel数据”</h3>
<p>书中只提到读取Excel文件可以使用readxl包；如果想写入Excel文件的话，可以使用openxlsx包。</p>
</div>
</div>
<div id="特殊注释" class="section level2">
<h2>特殊注释</h2>
<div id="p14-2.2-rstudio" class="section level3">
<h3>P14 “2.2 RStudio”</h3>
<p>本节中讲了一些RStudio里的快捷键，补充如下（Windows）：</p>
<ul>
<li>Alt + - ：快速输入“ &lt;- ”</li>
<li>Ctrl + Shift + M ：快速输入“ %&gt;% ”（或“ |&gt; ”，可以在RStudio中设置）</li>
<li>Ctrl + Alt + R ：运行当前脚本所有内容</li>
<li>Shift + Enter ：在控制台中换行</li>
<li>Ctrl + Shift +N ：新建脚本</li>
<li>Ctrl + S ：保存脚本</li>
<li>Ctrl + W ：关闭当前脚本</li>
<li>Ctrl + Shift + W ：关闭所有脚本</li>
</ul>
</div>
<div id="p40-4.8-管道" class="section level3">
<h3>P40 “4.8 管道”</h3>
<p>本节中有代码如下：</p>
<pre class="r"><code>library(magrittr)
x &lt;- 1:10
mean(x)</code></pre>
<pre><code>## [1] 5.5</code></pre>
<pre class="r"><code>x %&gt;% mean</code></pre>
<pre><code>## [1] 5.5</code></pre>
<p>这里的x %&gt;% mean也可以写成x %&gt;% mean()。事实上，R 4.1版本后，原生支持管道，但管道符写法与magrittr包不同，写作 |&gt; ，实现原理和用法也略有不同，比如，使用 |&gt; 必须写成x |&gt; mean()而不能写成x |&gt; mean，统计之都有与此相关的<a href="https://d.cosx.org/d/422269-r-410">讨论贴</a></p>
</div>
<div id="p46-5.1-数据框" class="section level3">
<h3>P46 “5.1 数据框”</h3>
<p>本节中有代码如下：</p>
<pre><code>x &lt;- 10:1
y &lt;- -4:5
q &lt;- c(&quot;Hockey&quot;,&quot;Football&quot;,&quot;Baseball&quot;,&quot;Curling&quot;,&quot;Rugby&quot;,
       &quot;Lacrosse&quot;,&quot;Basketball&quot;,&quot;Tennis&quot;,&quot;Cricket&quot;,&quot;Soccer&quot;)
theDF &lt;- data.frame(First=x,Second=y,Sport=q)
#省略···
class(theDF[,&quot;Sport&quot;])</code></pre>
<p>书中给出的结果为</p>
<pre><code>[1] &quot;factor&quot;</code></pre>
<p>但实际运行结果应为</p>
<pre><code>[1] &quot;character&quot;</code></pre>
<p>这是因为书中使用的R版本为3.4.0，而R自<a href="https://stat.ethz.ch/pipermail/r-announce/2020/000653.html">4.0.0版本</a>以后，更新为默认使用stringAsFactors = FALSE，即不再默认将数据框（data.frame）中的列向量转换为factor（因子）向量，所以实际运行结果会与书中有所差异。<br />
R 4.0.0于2020年4月24日发布，也就是说所有早于这个时间出版的书目都会存在相关问题。因此阅读一些相关资料时应当时刻注意到这个差异。</p>
</div>
<div id="p53-5.2-列表" class="section level3">
<h3>P53 “5.2 列表”</h3>
<p>本节有如下叙述：</p>
<p><em>“偶尔对列表或向量或数据框增加元素都还好，但是，如果反复这样做计算代价就太高了。所以最好创建指定长度的列表，然后通过合适的索引增加元素。”</em></p>
<p>如果没看懂这段描述的话，学完循环相关章节后，阅读下面两段代码：</p>
<p>事先指定了变量output的长度：</p>
<pre class="r"><code>#system.time函数可以计算一段代码的运行时间
system.time({
 output &lt;- rep(NA, 10000000)
 for (i in 1:10000000) {
 output[i] &lt;- i + 1
 }
})</code></pre>
<pre><code>## 用户 系统 流逝 
## 0.59 0.00 0.60</code></pre>
<p>未事先指定output的长度：</p>
<pre class="r"><code>system.time({
 output &lt;- NA
 for (i in 1:10000000) {
 output[i] &lt;- i + 1
 }
})</code></pre>
<pre><code>## 用户 系统 流逝 
## 2.92 0.09 3.08</code></pre>
<p>可以看出前者的运行速度大约是后者的3.6倍。原因是在后者中，R不得不每次循环都扩充一次output变量的长度。即每次循环，R都需要在计算机内存中复制原长度的output变量，同时腾出一块容量更大的区域，用来存储新长度的output变量，最后把原位置的output变量清除。在后一段代码中，这一系列创建、复制、粘贴、删除的繁琐操作共进行了10000000次！而前者的写法就很好地避免了这个问题！</p>
</div>
<div id="p61-6.2-读取excel数据-1" class="section level3">
<h3>P61 “6.2 读取Excel数据”</h3>
<p>本节中有代码如下：</p>
<pre><code>download.file(url=&#39;http://www.jaredlander.com/data/ExcelExample.xlsx&#39;,
              destfile=&#39;data/ExcelExample.xlsx&#39;,method=&#39;curl&#39;)</code></pre>
<p>运行应该会报错：</p>
<pre><code>Error in download.file(url = &quot;http://www.jaredlander.com/data/ExcelExample.xlsx&quot;,  : 
  &#39;curl&#39; call had nonzero exit status</code></pre>
<p>报错原因在于保存路径不对，因为本地的R工作目录可能与作者的不同，工作目录可以用getwd()查看，很可能本地工作目录下面没有创建data文件夹，于是报错。手动创建一个data文件夹即可。</p>
<p>但事情没有这么简单，即使不再报错，从网页写到本地的也可能（或者说一定）只是一个1KB的xlsx文件，也就是说无法使用，即这次写入其实是失败了。具体原因我不清楚，经查找<a href="https://stackoverflow.com/questions/59697422/why-method-curl-is-not-working-in-download-file-in-r/59697717#59697717?newreg=636c77acc9b043e5a2b0f3fe04ae9b17">资料</a>,可以改为这样写（即可成功）：</p>
<pre><code>download.file(url=&#39;http://www.jaredlander.com/data/ExcelExample.xlsx&#39;,
              destfile=&#39;data/ExcelExample.xlsx&#39;,mode=&#39;wb&#39;)</code></pre>
</div>
<div id="p68-6.7-读取网页数据" class="section level3">
<h3>P68 “6.7 读取网页数据*”</h3>
<p>本节有代码如下：</p>
<pre><code>library(XML)
theURL &lt;- &quot;http://www.jaredlander.com/2012/02/another-kind-of-super-bowl-pool/&quot;
bowlPool &lt;- readHTMLTable(theURL,which=1,header=FALSE,stringsAsFactors=FALSE)</code></pre>
<p>运行应该会报错：</p>
<pre><code>Error: failed to load external entity &quot;http://www.jaredlander.com/2012/02/another-kind-of-super-bowl-pool/&quot;</code></pre>
<p>原因我尚未探究，web方面的我比较欠缺，暂只留待以后解决。<br />
不过若换用课本紧接提到的rvest包，则就可以成功提取：</p>
<pre><code>library(rvest)
theURL &lt;- &quot;http://www.jaredlander.com/2012/02/another-kind-of-super-bowl-pool/&quot;
bowlPool &lt;- read_html(theURL) %&gt;% 
                 html_element(&quot;table&quot;) %&gt;% 
                 html_table()
#read_html() 爬取页面源代码
#html_element() 提取网页中指定元素的部分
#html_table() 根据提取的元素生成数据框或列表</code></pre>
<p>课本后面提取特定元素使用的函数是html_nodes（现在还可以使用），官网现在已经没有
这个函数的介绍了，其新的替代函数是html_elements。html_element和html_elements有所
不同，加“s”最终返回的会是一个列表。<br />
<em>Tip：XML包很经典，Hadley Wickham参考它开发了xml2包（2015年的blog），两个包孰优孰劣，因为我尚未探究，所以不得而知。</em></p>
</div>
<div id="p82-7.2-ggplot2" class="section level3">
<h3>P82 “7.2 ggplot2”</h3>
<p>本节有代码如下：</p>
<pre><code>econ2000 &lt;- economics[which(economics$year &gt;= 2000),]</code></pre>
<p>去掉which也可以：</p>
<pre class="r"><code>library(ggplot2)
library(lubridate)
economics$year &lt;- year(economics$date)
econ2000 &lt;- economics[which(economics$year &gt;= 2000),]
re_econ2000 &lt;- economics[economics$year &gt;= 2000,]
all(econ2000 == re_econ2000)</code></pre>
<pre><code>## [1] TRUE</code></pre>
<p>（或者说使用which可以提高运行效率？暂按。）</p>
</div>
<div id="p109-11.3-plyr包" class="section level3">
<h3>P109 “11.3 plyr包”</h3>
<p>本节有代码如下：<br />
&lt;1&gt;</p>
<pre class="r"><code>library(plyr)
system.time(
    replicate(1000,dlply(baseball,&quot;id&quot;,nrow))
)</code></pre>
<pre><code>##   用户   系统   流逝 
## 174.47   0.15 180.99</code></pre>
<pre class="r"><code>#我擅自增加了replicate函数
#因为只运行一次的话几乎运行时长很短，几乎看不出差别</code></pre>
<p>&lt;2&gt;</p>
<pre class="r"><code>library(plyr)
iBaseball &lt;- idata.frame(baseball)
system.time(replicate(100,dlply(iBaseball,&quot;id&quot;,nrow)))</code></pre>
<pre><code>##  用户  系统  流逝 
## 24.06  0.01 24.35</code></pre>
<p>课本中两者的运行时间分别为0.31和0.19，而这里的运行结果是88.89和94.59，为何两个结果不一致，不清楚。不过也许不重要，作者后面也提到将数据集转换为idata.frame格式能不能提高效率还得挑数据集。😵</p>
<p>&lt;3&gt;<br />
现在测试使用data.table的效率：</p>
<pre class="r"><code>library(data.table)
data(baseball,package = &quot;plyr&quot;)
bBaseball = data.table(baseball)
system.time(
  replicate(1000,
            bBaseball[,list(nrow=length(year)),by=id]
            )
)</code></pre>
<pre><code>## 用户 系统 流逝 
## 6.33 0.75 6.73</code></pre>
<pre class="r"><code>#这里使用的是length，原因是nrow在这儿用不了。
#事实上如果把上面的两段代码换成length，运行时间几乎与使用nrow相同。</code></pre>
<p>仅用时两秒！😮</p>
<p>&lt;4&gt;<br />
再测试使用dplyr包的效率：</p>
<pre class="r"><code>library(dplyr)
data(baseball,package = &quot;plyr&quot;)
dBaseball = tibble(baseball)
system.time(
  replicate(1000,
            dBaseball %&gt;% 
              group_by(id) %&gt;% 
              summarize(nrow=nrow(year))
            )
)</code></pre>
<pre><code>##  用户  系统  流逝 
## 26.03  0.01 26.70</code></pre>
<p>用时十秒。</p>
</div>
<div id="p139-12.11-dplyr使用数据库" class="section level3">
<h3>P139 “12.11 dplyr使用数据库”</h3>
<p>本节有代码如下：</p>
<pre><code>download.file(&quot;http://www.jaredlander.com/data/diamonds.db&quot;,
              destfile=&quot;data/diamonds.db&quot;,mode = &quot;wb&quot;)
diaDBSource &lt;- src_sqlite(&quot;data/diamonds.db&quot;)</code></pre>
<p>提示错误：找不到src_sqlite函数。原因是作者写作时dplyr包的版本为0.6，现在则为1.0.7。而1.0.0版本的相关更新说明如下：</p>
<blockquote>
<p>src_mysql(), src_postgres(), and src_sqlite() has been deprecated. We’ve recommended against them for some time. Instead please use the approach described at <a href="https://dbplyr.tidyverse.org/" class="uri">https://dbplyr.tidyverse.org/</a>.</p>
</blockquote>
<p>即现在建议使用dbplyr（dplyr的支援包）来操纵数据库。dbplyr官网中的写法已经不再使用src_sqlite函数，而是改用书中提到的另一种应用面更广的方法：使用DBI::dbConnect()函数。</p>
</div>
<div id="p172-16.3-提取文本" class="section level3">
<h3>P172 “16.3 提取文本”</h3>
<p>本节有代码如下：</p>
<pre><code>library(XML)
load(&quot;dadta/presidents.rdata&quot;)
theURL &lt;- &quot;http://www.loc.gov//rr/print/list/057_chron.html&quot;
presidents &lt;- readHTMLTable(theURL,which=3,as.data.frame=TRUE,
                           skip.rows=1,header=TRUE,stringsAsFactors=FALSE)</code></pre>
<p>运行应该会报错：</p>
<pre><code>Error: failed to load HTTP resource</code></pre>
<p>进入这个网址，会发现其设置了验证程序以防止爬取数据。</p>
<p>解决办法：人工复制这个网页的html源代码，保存为本地html文件，然后从本地爬取。</p>
<p>第二种爬取办法：保存到本地后，使用之前书上介绍过的rvest包。可以直接爬取出正确的表：</p>
<pre><code>library(rvest)
#假设文件被保存为bb.html
theURL &lt;- &quot;bb.html&quot;
presidents2 &lt;- (read_html(theURL) %&gt;% 
    html_elements(&quot;table&quot;) %&gt;% 
    html_table())[[4]]</code></pre>
</div>
</div>
<div id="运行环境" class="section level2">
<h2>运行环境</h2>
<pre class="r"><code>devtools::session_info()</code></pre>
<pre><code>## - Session info ---------------------------------------------------------------
##  setting  value
##  version  R version 4.1.2 (2021-11-01)
##  os       Windows 10 x64 (build 22000)
##  system   x86_64, mingw32
##  ui       RTerm
##  language (EN)
##  collate  Chinese (Simplified)_China.936
##  ctype    Chinese (Simplified)_China.936
##  tz       Asia/Taipei
##  date     2022-03-11
##  pandoc   2.17.0.1 @ D:/Program Files/Quarto/bin/ (via rmarkdown)
## 
## - Packages -------------------------------------------------------------------
##  package     * version date (UTC) lib source
##  assertthat    0.2.1   2019-03-21 [1] CRAN (R 4.1.2)
##  blogdown      1.7     2021-12-19 [1] CRAN (R 4.1.2)
##  bookdown      0.24    2021-09-02 [1] CRAN (R 4.1.2)
##  brio          1.1.3   2021-11-30 [1] CRAN (R 4.1.2)
##  bslib         0.3.1   2021-10-06 [1] CRAN (R 4.1.2)
##  cachem        1.0.6   2021-08-19 [1] CRAN (R 4.1.2)
##  callr         3.7.0   2021-04-20 [1] CRAN (R 4.1.2)
##  cli           3.1.0   2021-10-27 [1] CRAN (R 4.1.2)
##  colorspace    2.0-2   2021-06-24 [1] CRAN (R 4.1.2)
##  crayon        1.4.2   2021-10-29 [1] CRAN (R 4.1.2)
##  data.table  * 1.14.2  2021-09-27 [1] CRAN (R 4.1.2)
##  DBI           1.1.2   2021-12-20 [1] CRAN (R 4.1.2)
##  desc          1.4.0   2021-09-28 [1] CRAN (R 4.1.2)
##  devtools      2.4.3   2021-11-30 [1] CRAN (R 4.1.2)
##  digest        0.6.29  2021-12-01 [1] CRAN (R 4.1.2)
##  dplyr       * 1.0.7   2021-06-18 [1] CRAN (R 4.1.2)
##  ellipsis      0.3.2   2021-04-29 [1] CRAN (R 4.1.2)
##  evaluate      0.14    2019-05-28 [1] CRAN (R 4.1.2)
##  fansi         0.5.0   2021-05-25 [1] CRAN (R 4.1.2)
##  fastmap       1.1.0   2021-01-25 [1] CRAN (R 4.1.2)
##  fs            1.5.1   2021-11-30 [1] CRAN (R 4.1.2)
##  generics      0.1.1   2021-10-25 [1] CRAN (R 4.1.2)
##  ggplot2     * 3.3.5   2021-06-25 [1] CRAN (R 4.1.2)
##  glue          1.5.1   2021-11-30 [1] CRAN (R 4.1.2)
##  gtable        0.3.0   2019-03-25 [1] CRAN (R 4.1.2)
##  htmltools     0.5.2   2021-08-25 [1] CRAN (R 4.1.2)
##  jquerylib     0.1.4   2021-04-26 [1] CRAN (R 4.1.2)
##  jsonlite      1.7.2   2020-12-09 [1] CRAN (R 4.1.2)
##  knitr         1.37    2021-12-16 [1] CRAN (R 4.1.2)
##  lifecycle     1.0.1   2021-09-24 [1] CRAN (R 4.1.2)
##  lubridate   * 1.8.0   2021-10-07 [1] CRAN (R 4.1.2)
##  magrittr    * 2.0.1   2020-11-17 [1] CRAN (R 4.1.2)
##  memoise       2.0.1   2021-11-26 [1] CRAN (R 4.1.2)
##  munsell       0.5.0   2018-06-12 [1] CRAN (R 4.1.2)
##  pillar        1.6.4   2021-10-18 [1] CRAN (R 4.1.2)
##  pkgbuild      1.3.1   2021-12-20 [1] CRAN (R 4.1.2)
##  pkgconfig     2.0.3   2019-09-22 [1] CRAN (R 4.1.2)
##  pkgload       1.2.4   2021-11-30 [1] CRAN (R 4.1.2)
##  plyr        * 1.8.6   2020-03-03 [1] CRAN (R 4.1.2)
##  prettyunits   1.1.1   2020-01-24 [1] CRAN (R 4.1.2)
##  processx      3.5.2   2021-04-30 [1] CRAN (R 4.1.2)
##  ps            1.6.0   2021-02-28 [1] CRAN (R 4.1.2)
##  purrr         0.3.4   2020-04-17 [1] CRAN (R 4.1.2)
##  R6            2.5.1   2021-08-19 [1] CRAN (R 4.1.2)
##  Rcpp          1.0.7   2021-07-07 [1] CRAN (R 4.1.2)
##  remotes       2.4.2   2021-11-30 [1] CRAN (R 4.1.2)
##  rlang         0.4.12  2021-10-18 [1] CRAN (R 4.1.2)
##  rmarkdown     2.11    2021-09-14 [1] CRAN (R 4.1.2)
##  rprojroot     2.0.2   2020-11-15 [1] CRAN (R 4.1.2)
##  rstudioapi    0.13    2020-11-12 [1] CRAN (R 4.1.2)
##  sass          0.4.0   2021-05-12 [1] CRAN (R 4.1.2)
##  scales        1.1.1   2020-05-11 [1] CRAN (R 4.1.2)
##  sessioninfo   1.2.2   2021-12-06 [1] CRAN (R 4.1.2)
##  stringi       1.7.6   2021-11-29 [1] CRAN (R 4.1.2)
##  stringr       1.4.0   2019-02-10 [1] CRAN (R 4.1.2)
##  testthat      3.1.2   2022-01-20 [1] CRAN (R 4.1.2)
##  tibble        3.1.6   2021-11-07 [1] CRAN (R 4.1.2)
##  tidyselect    1.1.1   2021-04-30 [1] CRAN (R 4.1.2)
##  usethis       2.1.5   2021-12-09 [1] CRAN (R 4.1.2)
##  utf8          1.2.2   2021-07-24 [1] CRAN (R 4.1.2)
##  vctrs         0.3.8   2021-04-29 [1] CRAN (R 4.1.2)
##  withr         2.4.3   2021-11-30 [1] CRAN (R 4.1.2)
##  xfun          0.29    2021-12-14 [1] CRAN (R 4.1.2)
##  yaml          2.2.1   2020-02-01 [1] CRAN (R 4.1.1)
## 
##  [1] D:/Program Files/R/R-4.1.2/library
## 
## ------------------------------------------------------------------------------</code></pre>
</div>
